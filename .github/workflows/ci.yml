name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PNPM_VERSION: 10.11.0
  NODE_VERSION: "20"
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ secrets.TURBO_TEAM }}

jobs:
  setup:
    name: Setup Cache Keys
    runs-on: ubuntu-latest
    outputs:
      pnpm-cache-key: ${{ steps.pnpm-cache.outputs.cache-key }}
      turbo-cache-key: ${{ steps.turbo-cache.outputs.cache-key }}
    steps:
      - uses: actions/checkout@v4

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "cache-key=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Get turbo cache key
        id: turbo-cache
        shell: bash
        run: |
          echo "cache-key=turbo-${{ github.ref }}-${{ github.sha }}" >> $GITHUB_OUTPUT

  lint:
    name: Lint (pnpm + Turbo)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Restore pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-cache-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-cache-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Turbo lint
        run: pnpm turbo lint --no-cache

  typecheck:
    name: Type Check (TypeScript)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Restore pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-cache-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-cache-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Turbo typecheck
        run: pnpm turbo typecheck --no-cache

  test-frontend:
    name: Test (Frontend)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Restore pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-cache-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-cache-${{ runner.os }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Turbo test for frontend
        run: pnpm turbo test --no-cache --filter='./packages/*'
        continue-on-error: true

  test-rust:
    name: Test (Rust)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/desktop/src-tauri

      - name: Run Rust tests
        working-directory: packages/desktop/src-tauri
        run: cargo test --lib

      - name: Run Rust clippy
        working-directory: packages/desktop/src-tauri
        run: cargo clippy --all-targets --all-features -- -D warnings

  build-check:
    name: Build Check (Tauri)
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test-frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Restore pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-cache-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-cache-${{ runner.os }}-

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/desktop/src-tauri

      - name: Install Tauri dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            webkit2gtk-driver

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri (check only)
        run: pnpm --filter @focusflow/desktop tauri build --debug --ci

      - name: Upload build artifacts (on failure diagnosis)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-check-logs
          path: |
            packages/desktop/src-tauri/target/
            packages/desktop/dist/
          retention-days: 1

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test-frontend, test-rust, build-check]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.typecheck.result }}" == "failure" ]] || \
             [[ "${{ needs.test-frontend.result }}" == "failure" ]] || \
             [[ "${{ needs.test-rust.result }}" == "failure" ]] || \
             [[ "${{ needs.build-check.result }}" == "failure" ]]; then
            echo "CI pipeline failed"
            exit 1
          fi
          echo "All checks passed"
